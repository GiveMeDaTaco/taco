-- Waterfall full metrics SQL using Teradata's QUALIFY clause for deduplication
-- Context:
--   eligibility_table: base eligibility table name (with alias)
--   unique_identifiers: list of identifiers with alias (e.g. ['a.pty_id', 'a.accno'])
--   unique_without_aliases: list of identifier columns only (e.g. ['pty_id', 'accno'])
--   check_columns: ordered list of check column names (e.g. ['main_BA_1', 'main_BA_2', ...])
--   pre_filter: (optional) a pre-filter condition
WITH flags AS (
  SELECT
    {% for uid in unique_without_aliases %}{{ uid }}{{ "," if not loop.last }}{%- endfor %},
    {% for col in check_columns %}{{ col }}{{ "," if not loop.last }}{% endfor %}
  FROM {{ eligibility_table }} AS c
  {%- if pre_filter %}
  WHERE {{ pre_filter }}
  {%- endif %}
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY {{ unique_identifiers|join(', ') }}
    ORDER BY
      -- Criterion 1: Prefer row with the most 1s (descending)
      ({{ check_columns|join(' + ') }}) DESC,
      -- Criterion 2 (Tie-breaker): Prefer longest unbroken chain of 1s from the left (descending)
      (CASE
        {% for col in check_columns %}
          WHEN {% if loop.index0 > 0 %}{{ check_columns[:loop.index0]|join(' = 1 AND ') }} = 1 AND {% endif %}{{ col }} = 0 THEN {{ loop.index0 }}
        {% endfor %}
        ELSE {{ check_columns|length }}
      END) DESC
  ) = 1
)

-- This final calculation part remains exactly the same.
{%- for part in ['unique_drops', 'incremental_drops', 'remaining', 'cumulative_drops'] %}
SELECT
  '{{ part }}' AS stat_name,
  {%- for col in check_columns %}
  {%- if part == 'unique_drops' %}
    SUM(CASE WHEN {{ col }} = 0 THEN 1 ELSE 0 END) AS {{ col }}
  {%- elif part == 'incremental_drops' %}
    SUM(CASE WHEN {{ col }} = 0
      {%- for prev in check_columns[:loop.index0] %} AND {{ prev }} = 1{%- endfor %}
      THEN 1 ELSE 0 END) AS {{ col }}
  {%- elif part == 'remaining' %}
    SUM(CASE WHEN {{ col }} = 1
      {%- for prev in check_columns[:loop.index0] %} AND {{ prev }} = 1{%- endfor %}
      THEN 1 ELSE 0 END) AS {{ col }}
  {%- elif part == 'cumulative_drops' %}
    COUNT(*) - SUM(CASE WHEN {{ col }} = 1
      {%- for prev in check_columns[:loop.index0] %} AND {{ prev }} = 1{%- endfor %}
      THEN 1 ELSE 0 END) AS {{ col }}
  {%- endif %}{{ "," if not loop.last }}
  {%- endfor %}
FROM flags
{%- if not loop.last %}
UNION ALL
{%- endif %}
{%- endfor %};